<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Leptospirosis — Pencatatan Kasus</title>
<link rel="stylesheet" href="./style.css" />
<!-- Chart.js & XLSX -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Leaflet CSS & JS (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
</head>
<body>
  <!-- TOKEN OVERLAY -->
  <div id="lock" class="lock">
    <div class="lock-card">
      <div class="lock-title">Akses Terbatas</div>
      <div class="lock-sub">Masukkan token untuk membuka dashboard.</div>
      <form id="lockForm" class="lock-row">
        <input id="tokenInput" type="text" placeholder="Masukkan token…" autocomplete="off" />
        <button id="unlockBtn" type="submit" class="btn primary">Masuk</button>
      </form>
      <div id="lockErr" class="lock-err">Token salah. Coba lagi.</div>
    </div>
  </div>

  <header>
    <div class="wrap" style="position:relative">
      <h1>Dashboard Pencatatan Kasus Leptospirosis</h1>
      <div class="sub">Tema monokrom • Satu kolom memanjang • Data tersimpan lokal (browser)</div>
      <div class="badge neutral" id="defBadge">Definisi Kasus: —</div>
    </div>
  </header>

  <main>
    <section id="pasien">
      <h2>Data Pasien</h2>
      <div class="grid-2">
        <div>
          <label>Nama</label>
          <input id="nama" type="text" placeholder="Nama lengkap pasien"/>
        </div>
        <div>
          <label>Jenis Kelamin</label>
          <select id="jk">
            <option value="">Pilih...</option>
            <option>Laki-laki</option>
            <option>Perempuan</option>
          </select>
        </div>
        <div>
          <label>Umur (tahun)</label>
          <input id="umur" type="number" min="0" max="120" placeholder="cth: 34"/>
        </div>
        <div>
          <label>Pekerjaan</label>
          <input id="kerja" type="text" placeholder="cth: Petani"/>
        </div>
        <div>
          <label>Provinsi</label>
          <select id="prov"></select>
        </div>
        <div>
          <label>Kabupaten/Kota</label>
          <select id="kab"></select>
        </div>
      </div>
      <label>Alamat Lengkap (RT/RW, Kelurahan, Kecamatan/Dusun/Desa)</label>
      <textarea id="alamat" placeholder="Tulis alamat lengkap..."></textarea>
    </section>

    <section id="gejala">
      <h2>Riwayat Gejala</h2>
      <div class="muted small">Centang gejala yang muncul. Jika dicentang, isi tanggal munculnya gejala. Onset otomatis diambil dari tanggal gejala paling awal.</div>
      <div class="grid-2" id="gejalaGrid"></div>
      <div id="manualOnsetWrap" class="row hidden" style="margin-top:8px">
        <div style="min-width:260px">
          <label>Tanggal gejala (manual)</label>
          <input id="onsetManual" type="date" max="2025-09-10" />
          <div class="muted">Gunakan ini hanya jika <b>tidak ada gejala yang dicentang</b>.</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div><span class="muted">Tanggal onset (otomatis)</span></div>
        <div class="tag right" id="onsetTag">—</div>
      </div>
    </section>

    <section id="kontak">
      <h2>Riwayat Kontak</h2>
      <div class="grid-2">
        <div>
          <label>Tanggal Perkiraan Paparan</label>
          <input id="tglPaparan" type="date"/>
        </div>
      </div>
      <label class="muted">Centang faktor risiko dalam 2 minggu terakhir</label>
      <div class="grid-2" id="paparanGrid"></div>
    </section>

    <section id="lab">
      <h2>Hasil Pemeriksaan Lab</h2>
      <div class="grid-3">
        <div>
          <label>Leukosit (x10³/µL) <span class="muted">(N: 3.5–10.5)</span></label>
          <input id="leukosit" type="number" step="0.1" placeholder="cth: 7.2"/>
        </div>
        <div>
          <label>Trombosit (x10³/µL) <span class="muted">(N: 150–450)</span></label>
          <input id="trombosit" type="number" step="1" placeholder="cth: 180"/>
        </div>
        <div>
          <label>Bilirubin total (mg/dL) <span class="muted">(N: 0.1–1.2)</span></label>
          <input id="bilirubin" type="number" step="0.1" placeholder="cth: 1.8"/>
        </div>
        <div>
          <label>SGOT/AST (U/L) <span class="muted">(N: ≤40)</span></label>
          <input id="sgot" type="number" step="1" placeholder="cth: 32"/>
        </div>
        <div>
          <label>SGPT/ALT (U/L) <span class="muted">(N: ≤41)</span></label>
          <input id="sgpt" type="number" step="1" placeholder="cth: 28"/>
        </div>
        <div>
          <label>Kreatinin (mg/dL) <span class="muted">(N: 0.6–1.3)</span></label>
          <input id="kreatinin" type="number" step="0.1" placeholder="cth: 0.9"/>
        </div>
      </div>

      <div class="grid-3" style="margin-top:10px">
        <div>
          <label>RDT</label>
          <div class="row" role="radiogroup" aria-label="RDT">
            <label class="choice"><input type="radio" name="rdt" value="pos"> Positif</label>
            <label class="choice"><input type="radio" name="rdt" value="neg"> Negatif</label>
            <label class="choice"><input type="radio" name="rdt" value="nd"> Tidak diperiksa</label>
          </div>
        </div>
        <div>
          <label>Hasil MAT</label>
          <div class="row" role="radiogroup" aria-label="Hasil MAT">
            <label class="choice"><input type="radio" name="mat" value="pos"> Positif</label>
            <label class="choice"><input type="radio" name="mat" value="neg"> Negatif</label>
            <label class="choice"><input type="radio" name="mat" value="nd"> Tidak diperiksa</label>
          </div>
        </div>
        <div>
          <label>Serovar (jika ada)</label>
          <input id="serovar" type="text" placeholder="cth: L. icterohaemorrhagiae"/>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary class="muted">Opsi Lanjutan (Amilase, CPK, Urinalisis, PCR)</summary>
        <div class="grid-3" style="margin-top:10px">
          <div>
            <label>Amilase (U/L) <span class="muted">(N: 30–110)</span></label>
            <input id="amilase" type="number" step="1" placeholder="cth: 95"/>
          </div>
          <div>
            <label>CPK (U/L) <span class="muted">(N: 30–200)</span></label>
            <input id="cpk" type="number" step="1" placeholder="cth: 190"/>
          </div>
          <div>
            <label>PCR</label>
            <div class="row" role="radiogroup" aria-label="PCR">
              <label class="choice"><input type="radio" name="pcr" value="pos"> Positif</label>
              <label class="choice"><input type="radio" name="pcr" value="neg"> Negatif</label>
              <label class="choice"><input type="radio" name="pcr" value="nd"> Tidak diperiksa</label>
            </div>
          </div>
        </div>
        <div class="grid-2" style="margin-top:10px">
          <div class="symptom">
            <input type="checkbox" id="proteinuria"/>
            <label for="proteinuria" style="margin:0; font-weight:500">Proteinuria</label>
          </div>
          <div class="symptom">
            <input type="checkbox" id="hematuria"/>
            <label for="hematuria" style="margin:0; font-weight:500">Hematuria</label>
          </div>
        </div>
      </details>
      <div class="footnote">Rentang nilai normal bersifat indikatif; sesuaikan dengan referensi laboratorium setempat.</div>
    </section>

    <section id="status">
      <h2>Status Akhir Pasien</h2>
      <div class="grid-3">
        <div>
          <label>Status</label>
          <select id="statusAkhir">
            <option value="">Pilih...</option>
            <option value="Sembuh">Sembuh</option>
            <option value="Perawatan">Masih dalam perawatan</option>
            <option value="Meninggal">Meninggal</option>
          </select>
        </div>
        <div>
          <label>Tanggal Status</label>
          <input id="tglStatus" type="date"/>
        </div>
        <div>
          <label>Pemberian Obat</label>
          <input id="obat" type="text" placeholder="cth: Doksisiklin, Penicillin, dll."/>
        </div>
      </div>
    </section>

    <section id="aksi">
      <div class="row">
        <button class="btn primary" id="simpan">Simpan Kasus</button>
        <button class="btn" id="cancelEdit">Batal Edit</button>
        <button class="btn" id="reset">Reset Form</button>
        <span class="right"></span>
        <button class="btn" id="cekDup">Cek Duplikat</button>
        <button class="btn" id="hapusDup">Hapus Duplikat</button>
        <button class="btn" id="exportExcel">Ekspor Excel</button>
      </div>
    </section>

    <section id="tabel">
      <h2>Data Kasus Tersimpan</h2>
      <div class="case-counts" id="counts"></div>
      <div class="hr"></div>

      <div class="sticky-filters">
        <div class="toolbar">
          <div class="filters-grid">
            <div>
              <label>Mode Waktu</label>
              <select id="fTimeMode">
                <option value="month">Bulan</option>
                <option value="year">Tahun</option>
              </select>
            </div>
            <div class="time-month" id="monthRange">
              <label>Dari Bulan</label>
              <input id="fStart" type="month"/>
            </div>
            <div class="time-month" id="monthRange2">
              <label>Sampai Bulan</label>
              <input id="fEnd" type="month"/>
            </div>
            <div class="time-year" id="yearRange">
              <label>Dari Tahun</label>
              <input id="fYearStart" type="number" min="2000" max="2100" placeholder="mis. 2023"/>
            </div>
            <div class="time-year" id="yearRange2">
              <label>Sampai Tahun</label>
              <input id="fYearEnd" type="number" min="2000" max="2100" placeholder="mis. 2025"/>
            </div>
            <div class="span2">
              <div class="grid-2">
                <div>
                  <label>Filter Provinsi</label>
                  <select id="fProv"></select>
                </div>
                <div>
                  <label>Filter Kabupaten/Kota</label>
                  <select id="fKab"></select>
                </div>
              </div>
            </div>
            <div style="align-self:flex-end">
              <button class="btn" id="applyFilter">Terapkan</button>
            </div>
          </div>
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px">
        <table class="table" id="casesTable">
          <thead>
            <tr>
              <th>Nama</th><th>Umur</th><th>Provinsi</th><th>Kab/Kota</th>
              <th>Onset</th><th>Definisi</th><th>Status</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="grafik">
      <h2>Analisis & Grafik</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <label class="muted" id="trendTitle">Tren kasus per bulan</label>
          <canvas id="trendChart"></canvas>
        </div>
        <div class="chart-card">
          <label class="muted">Sebaran kasus per kabupaten/kota</label>
          <canvas id="kabChart"></canvas>
        </div>
      </div>
    </section>

    <section id="peta">
      <h2 aria-label="Judul peta">Sebaran Jumlah Kasus Leptospirosis per Provinsi, Indonesia</h2>
      <div class="sub" style="margin-top:-6px">Contoh data — ganti dengan data aktual</div>
      <div class="row" style="margin-top:12px">
        <button id="recalcMap" class="btn" title="Hitung peta berdasarkan data tersimpan">Hitung dari Data</button>
        <button id="exportPng" class="btn" title="Ekspor peta sebagai PNG">Export PNG</button>
      </div>
      <div id="map" aria-label="Peta persebaran kasus per provinsi"></div>
      <div id="mapMsg" class="muted" style="margin-top:8px"></div>
      <div class="footnote">Peta menggunakan GeoJSON provinsi dari tautan Anda (RAW GitHub). Background putih tanpa tile.</div>
    </section>

    <section id="sheetsSection">
      <h2>Sinkronisasi Google Sheets</h2>
      <div class="row">
        <button class="btn" id="pullSheets">Tarik dari Google Sheet</button>
        <button class="btn" id="syncSheets">Kirim ke Google Sheet</button>
        <button class="btn" id="fullSyncSheets" title="Ganti seluruh isi sheet dengan data unik terbaru dari aplikasi ini">Full Sync (Replace All)</button>
        <span id="pullStatus" class="muted" style="align-self:center"></span>
      </div>
      <div class="footnote">Pastikan Anda sudah mengisi <code>SHEETS_URL</code>, <code>SPREADSHEET_ID</code>, dan melakukan <em>Publish to web</em> pada sheet.</div>
    </section>

    <footer class="wrap" style="padding-bottom:48px">
      <div class="footnote">Data disimpan di <em>localStorage</em>. Untuk sinkronisasi Google Sheets, atur <code>apps_script.gs</code> & <code>SHEETS_URL</code> di <code>script.js</code>.</div>
    </footer>
  </main>

<script defer src="./script.js"></script>
</body>
</html>
